NOTES

## k3s on Synology needs containerd with a workaround

https://community.synology.com/enu/forum/1/post/150010 talks about needing the overlay driver

https://android.googlesource.com/kernel/build/ shows a way to build kernel mods in Bazel
https://android.googlesource.com/kernel/google-modules/raviole-device/+/refs/heads/android13-gs-raviole-5.15/BUILD.bazel
https://android.googlesource.com/kernel/build/+/refs/heads/main/kleaf/docs/impl.md

https://github.com/fenio/k3s-synology talks about a more scripted approach

For now, we package some geminilake as denverton and see what fails

## Docker env

```
docker build -t denverton -f spk/containerd/Dockerfile.fenio .
docker run -it --rm  -v $(pwd)/mods:/mods denverton /bin/bash
$ (cd /synology/env && tar Jxf /tarballs/base.txz && tar Jxf /tarballs/env.txz && tar Jxf /tarballs/dev.txz && tar Jxf /tarballs/linux.txz -C usr//local)
$ chroot /synology/env
CHROOT@ds.denverton[]# exec /bin/bash
CHROOT@ds.denverton[]# cd /usr/local/linux-4.4.x/
CHROOT@ds.denverton[/usr/local/linux-4.4.x/]# cp synoconfigs/denverton .config
CHROOT@ds.denverton[/usr/local/linux-4.4.x/]# vi .config
# setting the two modules:
# CONFIG_IP_NF_TARGET_REJECT=m
# CONFIG_NETFILTER_XT_MATCH_COMMENT=m
CHROOT@ds.denverton[/usr/local/linux-4.4.x/]# make menuconfig (no changes)
CHROOT@ds.denverton[/usr/local/linux-4.4.x/]# make modules ; find | grep -E '(REJECT|comment).ko$'
```

(failed)

Log suggests that the root, env, dev tarballs to not agree on a GLIBC version
```
  HOSTCC  scripts/extract-cert
/usr/local/x86_64-pc-linux-gnu/x86_64-pc-linux-gnu/sys-root/usr/lib/libcrypto.so: undefined reference to `pthread_once@GLIBC_2.34'
/usr/local/x86_64-pc-linux-gnu/x86_64-pc-linux-gnu/sys-root/usr/lib/libcrypto.so: undefined reference to `dlclose@GLIBC_2.34'
/usr/local/x86_64-pc-linux-gnu/x86_64-pc-linux-gnu/sys-root/usr/lib/libcrypto.so: undefined reference to `dlsym@GLIBC_2.34'

```
